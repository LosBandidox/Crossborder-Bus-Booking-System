<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bus Management</title>
    <link rel="stylesheet" href="/assets/css/AdminStyles.css"> <!-- Link to CSS -->
</head>
<body>
    <header>
        <div class="logo">
            <img src="/assets/Images/Logo.png" alt="InterBus Logo" class="logo-img">
        </div>
        <nav>
            <div class="hamburger">☰</div>
            <ul id="nav-menu">
                <li><a href="Admin.html">Dashboard</a></li>
                <li><a href="admin_users.html">Users</a></li>
                <li><a href="admin_buses.html">Buses</a></li>
                <li><a href="admin_routes.html">Routes</a></li>
                <li><a href="admin_schedules.html">Schedules</a></li>
                <li>
                    <a href="#">Others</a>
                    <ul class="dropdown">
                        <li><a href="admin_bookings.html">Bookings</a></li>
                        <li><a href="admin_payments.html">Payments</a></li>
                        <li><a href="admin_customers.html">Customer</a></li>
                        <li><a href="admin_staff.html">Staff</a></li>
                        <li><a href="admin_reports.html">Reports</a></li>
                        <li><a href="admin_activity.html">View Logs</a></li>
                    </ul>
                </li>
            </ul>
            <a href="../../../php/Logout.php" class="try-free-btn">Log out</a>
        </nav>
    </header>

    <main>
        <!-- Search input added to filter bus table -->
        <input type="text" id="busSearch" class="search-input" placeholder="Search buses...">
        <!-- Placeholder added to show if no buses match the search -->
        <p id="noBuses" class="no-results" style="display: none;">No buses found.</p>
        <!-- Link to Add Bus page -->
        <a href="add_bus.html" class="btn">Add New Bus</a>
        <button class="back-btn" onclick="goBack()">Back</button>

        <!-- Table for displaying buses -->
        <table id="busTable">
            <thead>
                <tr>
                    <th>Bus ID</th>
                    <th>Bus Number</th>
                    <th>Year of Manufacture</th>
                    <th>Capacity</th>
                    <th>Engine Number</th>
                    <th>Status</th>
                    <th>Mileage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="busTableBody">
                <!-- Bus data will be dynamically inserted here -->
            </tbody>
        </table>
    </main>

    <script>
// Function to get bus data
// - A user-defined async JavaScript function named fetchBuses, with no inputs.
// - Sends a web request to retrieve bus data and fills a table on the admin buses page.
// - Displays all buses for admins to view, edit, or delete.
async function fetchBuses() {
    // Handles potential errors
    // - A try-catch block to manage issues like network failures or bad data.
    // - Attempts to fetch and display bus data, catching any problems.
    // - Keeps the page from breaking on errors.
    try {
        // Sends a web request
        // - A user-defined constant named response, holding the result of an await fetch() call to '../../../php/admin/fetchBuses.php'.
        // - Requests all bus data from the server.
        // - Waits for the server’s reply with bus information.
        const response = await fetch('../../../php/admin/fetchBuses.php');

        // Gets the bus data
        // - A user-defined constant named buses, holding the JSON object from response.json().
        // - Turns the server’s reply into an array of bus objects.
        // - Prepares the data to fill the table.
        const buses = await response.json();

        // Finds the table body
        // - A user-defined constant named tableBody, holding the result of document.getElementById(), a built-in JavaScript method, targeting the element with ID 'busTableBody'.
        // - Targets the table’s <tbody> where bus rows will be added.
        // - Prepares the table for dynamic content.
        const tableBody = document.getElementById('busTableBody');

        // Clears the table
        // - Sets tableBody.innerHTML, a built-in property, to an empty string.
        // - Removes any existing rows in the table.
        // - Ensures no duplicate rows are shown.
        tableBody.innerHTML = '';

        // Goes through each bus
        // - Uses forEach(), a built-in JavaScript method, to loop over the buses array with a parameter named bus (a bus object).
        // - Creates a table row for each bus with its details.
        // - Builds the table dynamically with bus data.
        buses.forEach(bus => {
            // Creates a table row
            // - A user-defined constant named row, holding the result of document.createElement('tr'), a built-in method.
            // - Makes a new <tr> element for a single bus.
            // - Prepares the row for bus details and actions.
            const row = document.createElement('tr');

            // Fills the row with data
            // - Sets row.innerHTML, a built-in property, to a template literal with bus properties like BusID and BusNumber.
            // - Adds table cells (<td>) with bus details and buttons for editing/deleting.
            // - Displays bus information and action links for admins.
            row.innerHTML = `
                <td>${bus.BusID}</td>
                <td>${bus.BusNumber}</td>
                <td>${bus.YearOfManufacture}</td>
                <td>${bus.Capacity}</td>
                <td>${bus.EngineNumber}</td>
                <td>${bus.Status}</td>
                <td>${bus.Mileage}</td>
                <td>
                    <a href="edit_bus.html?id=${bus.BusID}" class="btn">Edit</a>
                    <button onclick="deleteBus(${bus.BusID})">Delete</button>
                </td>
            `;

            // Adds the row to the table
            // - Calls tableBody.appendChild(), a built-in method, to add the row to tableBody.
            // - Places the bus row in the table.
            // - Updates the table display with the bus data.
            tableBody.appendChild(row);
        });
    } catch (error) {
        // Logs the error
        // - Uses console.error(), a built-in method, to write “Error fetching buses:” and the error to the developer tools.
        // - Helps developers debug issues like network or server problems.
        console.error('Error fetching buses:', error);
    }
}

// Sets up the page to load bus data and enable searching
// - Adds an event listener using document.addEventListener(), a built-in method, for the “DOMContentLoaded” event.
// - Runs an anonymous arrow function when the page’s HTML is fully loaded.
// - Loads bus data and sets up search functionality for the admin buses page.
document.addEventListener('DOMContentLoaded', () => {
    // Loads bus data
    // - Calls the user-defined fetchBuses() function.
    // - Fills the bus table with data from the server.
    // - Displays the bus list when the page opens.
    fetchBuses();

    // Sets up the search field
    // - Adds an event listener using document.getElementById('busSearch').addEventListener(), targeting the input with ID 'busSearch' for the 'input' event.
    // - Runs an anonymous arrow function when the admin types in the search field.
    // - Filters the bus table based on user input.
    document.getElementById('busSearch').addEventListener('input', () => {
        // Filters the table
        // - Calls the user-defined filterTable() function (from script.js) with arguments 'busTable', 'busSearch', 'noBuses', and [0, 1, 4].
        // - Searches BusID (column 0), BusNumber (column 1), and EngineNumber (column 4).
        // - Updates the table to show only matching rows.
        filterTable('busTable', 'busSearch', 'noBuses', [0, 1, 4]);
    });
});

// Function to delete a bus
// - A user-defined async JavaScript function named deleteBus, with one input: busId (number or string).
// - Asks for confirmation, sends a delete request, and refreshes the table.
// - Allows admins to remove a bus from the system.
async function deleteBus(busId) {
    // Asks for confirmation
    // - Uses confirm(), a built-in JavaScript method, with a message including busId.
    // - Shows a pop-up asking the admin to confirm deletion.
    // - Proceeds only if the admin clicks “OK”.
    if (confirm(`Are you sure you want to delete bus with ID: ${busId}?`)) {
        // Handles potential errors
        // - A try-catch block to manage issues like network failures during deletion.
        // - Attempts to delete the bus and catches any problems.
        // - Keeps the page from breaking on errors.
        try {
            // Sends a web request
            // - A user-defined constant named response, holding the result of an await fetch() call to '../../../php/admin/deleteBus.php?id=${busId}'.
            // - Requests the server to delete the bus with the given ID.
            // - Waits for the server’s reply on the deletion.
            const response = await fetch(`../../../php/admin/deleteBus.php?id=${busId}`);

            // Gets the server response
            // - A user-defined constant named result, holding the JSON object from response.json().
            // - Turns the server’s reply into an object with status and message.
            // - Prepares to check if the deletion succeeded.
            const result = await response.json();

            // Checks for success
            // - A conditional statement checking if result.status equals 'success'.
            // - Shows a success message and refreshes the table, or displays an error.
            // - Handles the server’s response to the delete request.
            if (result.status === 'success') {
                // Shows a success message
                // - Calls alert(), a built-in method, with “Bus deleted successfully”.
                // - Tells the admin the bus was removed from the system.
                // - Confirms the deletion worked.
                alert('Bus deleted successfully');

                // Refreshes the table
                // - Calls the user-defined fetchBuses() function.
                // - Reloads the bus data to update the table.
                // - Removes the deleted bus from the display.
                fetchBuses();
            } else {
                // Shows an error message
                // - Calls alert() with “Failed to delete bus”.
                // - Tells the admin the deletion didn’t work.
                // - Provides feedback on the failure.
                alert('Failed to delete bus');
            }
        } catch (error) {
            // Logs the error
            // - Uses console.error() to write “Error deleting bus:” and the error to the developer tools.
            // - Helps developers debug issues like network or server problems.
            console.error('Error deleting bus:', error);
        }
    }
}
</script>
    <script src="/assets/js/script.js" defer></script>
</body>
</html>